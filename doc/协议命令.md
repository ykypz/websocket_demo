# 协议命令

## 命令说明

### 发送命令基本格式

所有发送消息遵循一致的基本结构，为json格式对象的字符串，构成部分为

- `requestId`: 以yyyyMMddHHmmssSSS格式形式用于一一匹配对应命令
- `command`: 规定格式的控制命令
- `params`: 根据控制命令支持的参数进行参数设置，无参数设置为空

``` json
{
    "requestId": "202508026105405085", 
    "command": "setExposureTime",
    "params": {
        "exposureTime": 0.8
    }
}  
```

### 返回命令基本格式

#### 字符串类型

字符串类型命令返回是**控制命令，参数设置，参数获取**相关命令发送后的反馈命令。所有返回消息遵循一致的基本结构，为json格式对象的字符串，构成部分为

- `requestId`: 对应请求ID，用于匹配请求响应
- `command`: 对应请求命令，用于识别相应类型
- `status`: 执行状态返回，包括success、error、pending、timeout等状态
- `data`: **可选项**-如果返回状态为成功，根据控制命令返回结果进行结果说明，如果，无结果返回设置为空
- `errorMessage`: **可选项**-如果返回状态为error或timeout，按照状态码定义进行详细错误信息返回

``` json
{
    "requestId": "202508026105405085", 
    "command": "getExposureTime",
    "status": "success",
    "data": {
        "exposureTime": 0.8
    },
    "errorMessage": {
        "code": 1001,
        "message": "未连接主机" 
    }
}  
```

#### 二进制类型

二进制类型命令返回是的是视频图片或测量结果，所有返回消息遵循一致的基本结构，按照**小端字节序**传输，为包含信息头说明和原始数据数据二进制数据，构成部分为：

- `messageType`: 数据对应类型，0x01=StreamImage 0x02=MeasureResult
- `contexId`: 数据对应id，通过datasetid可以将其与获取面形数据面形返回id一一对应
- `format`: 数据类型，针对stream时返回为图片原始数据，针对dataset返回为数据类型
- `width`: 原始数据从二维展开为一维前的宽度
- `height`: 原始数据从二维展开为一维前的高度
- `payloadLength`: 原始数据占据字节数

``` cpp
// 二进制数据头 18字节
struct BinaryHeader {
    uint8_t messageType; // 0x01=StreamImage 0x02=MeasureResult
    uint32_t contexId; // streamID/datasetId
    uint8_t format; // 针对stream 8-gray 24-rgb 针对dataset 64-double
    uint16_t width;
    uint16_t height;
    uint32_t payloadLength; // 原始数据总字节数
};
```

## 支持命令说明

### 设置观察模式

设置观察视频流模式
可设参数-视频流模式(`alignViewMode`)，有且支持两种模式，视频流监视对准视频流(`align`)和干涉视频流(`view`)

``` json
// 发送命令
{
    "requestId": "202508026105405085", 
    "command": "setAlignViewMode",
    "params": { 
        "alignViewMode": "align"
    }
}
// 返回命令
{
    "requestId": "202508026105405085", 
    "command": "setAlignViewMode",
    "status": "success"
}
```

### 获取观察模式

获取当前的观察视频流模式选择

``` json
// 发送命令
{
    "requestId": "202508026105405085", 
    "command": "getAlignViewMode",
    "params": {}
}
// 返回命令 
{
    "requestId": "202508026105405085", 
    "command": "getAlignViewMode",
    "status": "success",
    "data": {
        "alignViewMode": "align"
    }
}
```

### 开始视频流发送

开始视频流发送，默认情况下按照干涉视频流(`view`)进行视频流发送
监视对准视频流(`align`): 1280\*720分辨率（原分辨率），30Hz的图像发送
干涉视频流(`view`): 1024\*1024分辨率（降采样后分辨率），30Hz的图像发送

``` json
// 发送命令
{
    "requestId": "202508026105405085", 
    "command": "startStream",
    "params": {}
}
// 返回命令
{
    "requestId": "202508026105405085", 
    "command": "startStream",
    "status": "success",
    "data": {
        "streamId": "0x01000001"
    }
}
```

### 停止视频流发送

停止视频流发送

``` json
// 发送命令
{
    "requestId": "202508026105405085", 
    "command": "stopStream",
    "params": {}
}
// 返回命令
{
    "requestId": "202508026105405085", 
    "command": "stopStream",
    "status": "success"
}
```

### 开始测量

控制干涉仪进行单次测量操作

``` json
// 发送命令
{
    "requestId": "202508026105405085", 
    "command": "executeMeasure",
    "params": {}
}
// 即时返回命令（是否成功接收命令）
{
    "requestId": "202508026105405085", 
    "command": "executeMeasure",
    "status": "pending"
}
// 完成测量后返回命令（成功完成测量或失败）
{
    "requestId": "202508026105405085", 
    "command": "executeMeasure",
    "status": "success"
}
```

### 停止测量

控制干涉仪停止当前次测量操作

``` json
// 发送命令
{
    "requestId": "202508026105405085", 
    "command": "stopMeasure",
    "params": {}
}
// 即时返回命令（是否成功接收命令）
{
    "requestId": "202508026105405085", 
    "command": "stopMeasure",
    "status": "pending"
}
// 停止测量后返回命令（成功停止测量或失败）
{
    "requestId": "202508026105405085", 
    "command": "stopMeasure",
    "status": "success"
}  
```

### 测量状态查询

查看当前干涉仪的测量状态

``` json
// 发送命令
{
    "requestId": "202508026105405085", 
    "command": "getMeasureStatus",
    "params": {}
}
// 返回当前测量状态
{
    "requestId": "202508026105405085", 
    "command": "getMeasureStatus",
    "status": "success",
    "data": {
        "isMeasuring": false
    }
}
    
```

### 获取面形数据

获取测量的面形数据，获取数据为上一次测量完成后面形数据

``` json
// 发送命令
{
    "requestId": "202508026105405085", 
    "command": "getSurfaceData",
    "params": {}
}
// 返回当前面形结果信息
{
    "requestId": "202508026105405085", 
    "command": "getSurfaceData",
    "status": "success",
    "data": {
        "datasetId": "0x02000001"
    }
} 
// 二进制数据返回（BinaryHeader+rawData）
```
